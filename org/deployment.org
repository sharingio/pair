#+TITLE: Deployment

* Preparation

In this deployment, we presume the following things of your cluster:
- an ingress controller
- DNS management via a DNS provider [[https://github.com/kubernetes-sigs/external-dns#status-of-providers][supported by External-DNS]]

Install Cert-Manager:
#+BEGIN_SRC
kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.3.1/cert-manager.yaml
#+END_SRC

Install Helm-Operator:
#+BEGIN_SRC tmate :window pair-setup
helm repo add fluxcd https://charts.fluxcd.io
kubectl apply -f https://raw.githubusercontent.com/fluxcd/helm-operator/1.2.0/deploy/crds.yaml
helm upgrade -i helm-operator --create-namespace fluxcd/helm-operator \
    --namespace helm-operator \
    --set helm.versions=v3
#+END_SRC

(Management with Helm-Operator is recommended but optional)

Install Cluster-API, with support for Packet/Equinix Metal:
#+BEGIN_SRC tmate :window pair-setup
export PACKET_API_KEY="my-api-key"
clusterctl init --infrastructure packet
#+END_SRC

Install External-DNS. Installation can differ from where it's being installed.
The production external-dns is available in [[./external-dns/external-dns.org][external-dns.org]].

* Installation

Create a namespace:
#+begin_src tmate :window pair-setup
kubectl create ns sharingio-pair
#+end_src

A basic installation looks like this:
#+BEGIN_SRC yaml :tangle
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: sharingio-pair
  namespace: sharingio-pair
spec:
  releaseName: sharingio-pair
  chart:
    git: https://github.com/sharingio/pair.git
    ref: 2021.05.28.1515
    path: charts/sharingio-pair
  values:
    timezone: Pacific/Auckland
    instance:
      kubernetesVersion: 1.21.0
      humacsRepository: registry.gitlab.com/humacs/humacs/ii
      humacsVersion: 2021.05.27.2050
      nodeSize: c1.small.x86
    sessionSecret: pairpairpairpair
    githubOAuth:
      id: my-github-oauth-app-id
      secret: my-github-oauth-app-secret
    equinixMetal:
      projectID: my-equinix-metal-project-id
    ingress:
      enabled: true
      certmanager:
        enabled: true
      hosts:
        - host: pair.sharing.io
          paths:
            - /
#+END_SRC

To find ways of configuring your Pair, check out [[./configuration.org][the configuration docs]].
